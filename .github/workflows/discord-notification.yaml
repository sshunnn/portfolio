name: Notify Discord on Push

on:
  push:
    branches:
      - main # é€šçŸ¥ã‚’é€ä¿¡ã—ãŸã„ãƒ–ãƒ©ãƒ³ãƒã‚’æŒ‡å®š

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install Vercel CLI
        run: npm install -g vercel
        
      - name: Get Vercel deployment info
        id: vercel-info
        run: |
          # Vercel APIã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæƒ…å ±ã‚’å–å¾—
          DEPLOYMENT_URL=$(curl -s -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
            "https://api.vercel.com/v6/deployments?projectId=${{ secrets.VERCEL_PROJECT_ID }}&limit=1" | \
            jq -r '.deployments[0].url')
          echo "deployment_url=https://$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
        
      - name: Send Discord Notification
        run: |
          curl -H "Content-Type: application/json" \
               -d "{
                 \"embeds\": [
                   {
                     \"title\": \"ğŸš€ ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã—ãŸï¼\",
                     \"description\": \"æ–°ã—ã„å¤‰æ›´ãŒVercelã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã—ãŸã€‚\",
                     \"color\": 5814783,
                     \"fields\": [
                       {
                         \"name\": \"ğŸ‘¤ æ›´æ–°è€…\",
                         \"value\": \"\`${{ github.actor }}\`\",
                         \"inline\": true
                       },
                       {
                         \"name\": \"ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ\",
                         \"value\": \"\`${{ github.ref_name }}\`\",
                         \"inline\": true
                       },
                       {
                         \"name\": \"ğŸ“ ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸\",
                         \"value\": \"${{ github.event.head_commit.message }}\",
                         \"inline\": false
                       },
                       {
                         \"name\": \"ğŸ”— ãƒ‡ãƒ—ãƒ­ã‚¤URL\",
                         \"value\": \"[ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚’è¦‹ã‚‹](${{ steps.vercel-info.outputs.deployment_url }})\",
                         \"inline\": false
                       }
                     ],
                     \"timestamp\": \"${{ github.event.head_commit.timestamp }}\",
                     \"footer\": {
                       \"text\": \"GitHub Actions\",
                       \"icon_url\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\"
                     }
                   }
                 ]
               }" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}
